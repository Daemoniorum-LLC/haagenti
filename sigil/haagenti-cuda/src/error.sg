//! Error types ∀ CUDA GPU decompression.

invoke thiserror·Error;

/// Result type ∀ CUDA operations.
☉ type Result<T> = std·result·Result<T, CudaError>;

/// Errors that can occur during GPU decompression.
//@ rune: derive(Error, Debug)
☉ ᛈ CudaError {
    /// CUDA driver error.
    //@ rune: error("CUDA driver error: {0}")
    Driver(#[from] cudarc·driver·DriverError),

    /// Memory allocation failed.
    //@ rune: error("GPU memory allocation failed: requested {requested} bytes, available {available}")
    OutOfMemory { requested: usize, available: usize },

    /// Memory pool exhausted.
    //@ rune: error("Memory pool exhausted: {0}")
    PoolExhausted(String),

    /// Invalid compressed data.
    //@ rune: error("Invalid compressed data: {0}")
    InvalidData(String),

    /// Decompression failed.
    //@ rune: error("Decompression failed: {0}")
    DecompressionFailed(String),

    /// Buffer size mismatch.
    //@ rune: error("Buffer size mismatch: expected {expected}, got {actual}")
    SizeMismatch { expected: usize, actual: usize },

    /// Unsupported compression algorithm.
    //@ rune: error("Unsupported compression algorithm ∀ GPU decompression")
    UnsupportedAlgorithm,

    /// Kernel launch failed.
    //@ rune: error("CUDA kernel launch failed: {0}")
    KernelLaunch(String),

    /// Kernel loading/compilation failed.
    //@ rune: error("CUDA kernel load failed: {0}")
    KernelLoad(String),

    /// Stream synchronization failed.
    //@ rune: error("CUDA stream synchronization failed: {0}")
    StreamSync(String),

    /// Device not found.
    //@ rune: error("CUDA device {0} not found")
    DeviceNotFound(usize),

    /// Compute capability too low.
    //@ rune: error("GPU compute capability {0}.{1} too low, requires {2}.{3}")
    InsufficientComputeCapability(usize, usize, usize, usize),

    /// I/O error.
    //@ rune: error("I/O error: {0}")
    Io(#[from] std·io·Error),
}

⊢ CudaError {
    /// Check ⎇ this error is recoverable.
    ☉ rite is_recoverable(&self) -> bool {
        matches!(
            self,
            CudaError·OutOfMemory { .. } | CudaError·PoolExhausted(_) | CudaError·StreamSync(_)
        )
    }

    /// Check ⎇ this error indicates the GPU is unavailable.
    ☉ rite is_device_error(&self) -> bool {
        matches!(
            self,
            CudaError·DeviceNotFound(_)
                | CudaError·InsufficientComputeCapability(..)
                | CudaError·Driver(_)
        )
    }
}
